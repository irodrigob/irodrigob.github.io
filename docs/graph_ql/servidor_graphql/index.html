<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Servidor GraphQL">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Servidor GraphQL" />
<meta property="og:description" content="Servidor GraphQL" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://irodrigob.github.io/docs/graph_ql/servidor_graphql/" />
<meta property="article:modified_time" content="2022-01-03T20:17:15+01:00" />
<title>Servidor GraphQL | Navi-developer</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.e40449dffab36960ca7d6bac529d52d7ab9f9d230ffe5de1799e29cb61bc0cb7.css" integrity="sha256-5ARJ3/qzaWDKfWusUp1S16ufnSMP/l3heZ4py2G8DLc=">
<script defer src="/en.search.min.131764c3d2a6fc609ba927a2ca718658fe79b25566e244b147c6827a6198de6a.js" integrity="sha256-Exdkw9Km/GCbqSeiynGGWP55slVm4kSxR8aCemGY3mo="></script>

<script defer src="/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js" integrity="sha256-dKi7B/C&#43;6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>Navi-developer</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/github/" class="collapsed ">Github</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/graph_ql/" class="collapsed ">GraphQL</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/graph_ql/resolvers/" class="">Resolvers</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/graph_ql/schemas/" class="">Schemas</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/graph_ql/servidor_graphql/" class="active">Servidor GraphQL</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/hugo/" class="">Hugo</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/hugo/publicar_web_github/" class="">Publicar Web Github</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/mongodb/" class="">MongoDB</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/mongodb/usando_app/" class="">MongoDB en aplicaciones</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/mongodb/usando_app/mongoose/" class="">Mongoose</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/mongodb/cloud/" class="collapsed ">MongoDB en cloud</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/" class="collapsed ">Python</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/react/" class="collapsed ">React</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/" class="">SAP</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/sap/abap/" class="collapsed ">ABAP</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/BW/" class="collapsed ">BW</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/gateway/" class="collapsed ">Gateway</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/ui5/" class="collapsed ">UI5</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/ventas/" class="collapsed ">Ventas</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  











  
<ul>
  
  <li>
    <a href="https://github.com/irodrigob" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Servidor GraphQL</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introducción">Introducción</a></li>
    <li><a href="#instalación">Instalación</a></li>
    <li><a href="#configurando-el-schema">Configurando el schema</a></li>
    <li><a href="#conectado-mongodb">Conectado MongoDB</a></li>
    <li><a href="#probando-en-sandbox">Probando en sandbox</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="introducción">
  Introducción
  <a class="anchor" href="#introducci%c3%b3n">#</a>
</h1>
<p>Este artículo esta basado es este 
  <a href="https://www.smashingmagazine.com/2020/10/graphql-server-next-javascript-api-routes/">artículo</a>.Puede ser que los pasos que haga difieran un poco del artículo pero es lo que tiene basarse en un artículo de hace un año, y más como avanza de rápido estos lenguajes.</p>
<p>En este artículo haremos la instalación básica del servidor de GraphQL.</p>
<h1 id="instalación">
  Instalación
  <a class="anchor" href="#instalaci%c3%b3n">#</a>
</h1>
<p>Antes de hacer la instalación he creado la siguiente estructura de carpetas en mi proyecto:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">|- pages
|--- api
|----- graphql.js
|----- resolvers
|------- index.js
|----- schemas
|------- index.js
</code></pre></div><p>Que es cada cosa:</p>
<ul>
<li>Carpeta API &ndash;&gt; Es la carpeta que se usa para poder montar servicios en NextJS. Esta página cuando la aplicación esta corriendo se mapea a */api/**. Diriamos que es el endpoint de los servicios.</li>
<li>Archivo graphql.js &ndash;&gt; Es donde se indica la configuración para que arranque el servidor.</li>
<li>Carpeta resolvers &ndash;&gt; Es donde donde se ejecutan las consultas. En nuestro caso serán las llamadas a MongoDB.</li>
<li>Carpeta schemas &ndash;&gt; Es donde se definen los tipos de datos que se usarán en las consultas o mutaciones. A modo de simil sería el WSDL en los Webservices o los Entitys en servicios REST.</li>
</ul>
<p>El paquete que instalaremos es el <em>apollo-server-micro</em> mediante la sentencia:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">npm install apollo-server-micro
</code></pre></div><p>Este paquete esta pensando para Nextjs ya que el propio servidor se inicia cuando arrancamos la aplicación NextJS, evitando tener que arrancas dos servidor a la vez.</p>
<p>A continuación en el fichero <em>graphql.js</em> escribiremos lo siguiente:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">import <span style="color:#75715e">{</span> <span style="color:#a6e22e">ApolloServer</span> <span style="color:#75715e">}</span> from &#34;apollo-server-micro&#34;;
import <span style="color:#75715e">{</span> <span style="color:#a6e22e">typeDefs</span> <span style="color:#75715e">}</span> from &#34;./schemas&#34;;
import <span style="color:#75715e">{</span> <span style="color:#a6e22e">resolvers</span> <span style="color:#75715e">}</span> from &#34;./resolvers&#34;;

const apolloServer = new ApolloServer(<span style="color:#75715e">{</span> <span style="color:#a6e22e">typeDefs</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">resolvers</span> <span style="color:#75715e">}</span>);

const startServer = apolloServer.start();

export default async function handler(req, res) <span style="color:#75715e">{</span>
  <span style="color:#a6e22e">res</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Access-Control-Allow-Credentials&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">);</span>
  <span style="color:#a6e22e">res</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span>
    <span style="color:#e6db74">&#34;Access-Control-Allow-Origin&#34;</span><span style="color:#f92672">,</span>
    <span style="color:#e6db74">&#34;https://studio.apollographql.com&#34;</span>
  <span style="color:#f92672">);</span>
  <span style="color:#a6e22e">res</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span>
    <span style="color:#e6db74">&#34;Access-Control-Allow-Headers&#34;</span><span style="color:#f92672">,</span>
    <span style="color:#e6db74">&#34;Origin, X-Requested-With, Content-Type, Accept&#34;</span>
  <span style="color:#f92672">);</span>
  <span style="color:#a6e22e">if</span> <span style="color:#f92672">(</span><span style="color:#a6e22e">req</span><span style="color:#f92672">.</span><span style="color:#a6e22e">method</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;OPTIONS&#34;</span><span style="color:#f92672">)</span> <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">res</span><span style="color:#f92672">.</span><span style="color:#a6e22e">end</span><span style="color:#f92672">();</span>
    <span style="color:#a6e22e">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
  <span style="color:#75715e">}</span>

  <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">startServer</span><span style="color:#f92672">;</span>
  <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">apolloServer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">createHandler</span><span style="color:#f92672">(</span><span style="color:#75715e">{</span>
    <span style="color:#a6e22e">path</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/api/graphql&#34;</span><span style="color:#f92672">,</span>
  <span style="color:#75715e">}</span><span style="color:#f92672">)(</span><span style="color:#a6e22e">req</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">res</span><span style="color:#f92672">);</span>
<span style="color:#75715e">}</span>

export const config = <span style="color:#75715e">{</span>
  <span style="color:#a6e22e">api</span><span style="color:#f92672">:</span> <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">bodyParser</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>
  <span style="color:#75715e">}</span><span style="color:#f92672">,</span>
<span style="color:#75715e">}</span>;

</code></pre></div><p>Aquí tenemos un ejemplo que a veces los ejemplos que vienen en NextJs a veces no funcionan porque se basan en versiones antiguas y cuya configuración ha variado. Yo me base en el siguiente 
  <a href="https://github.com/vercel/next.js/tree/canary/examples/api-routes-apollo-server">ejemplo de NextJS</a> donde se ve una aplicación de ejemplo para comprobar que estamos poniendo las cosas correctamente. Pero esta configuración no me funciona porque desde la versión 3 Apollo arranca su propio sandbox y la manera de arrancarse es distinta. En el ejemplo de Nextjs que he usado como base es 
  <a href="https://github.com/vercel/next.js/tree/canary/examples/api-routes-graphql">este</a> y es el que me ha funcionado.</p>
<p>Hay ejemplos de NextJS donde el schema y los resolvers los pone todo junto en el propio fichero de configuración de GraphQL, aunque en otros los tiene separado, yo opto por separarlos porque no hay que perder las buenas prácticas.</p>
<p>Si en consola arrancamos la aplicación:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">npm run dev
</code></pre></div><p>Arrancará bien sin problemas. Pero si accedemos a la siguiente URL:</p>
<pre><code>http://localhost:3000/api/graphql
</code></pre><p>Nos va a dar un error porque los schemas no están configurados. Esta URL es la que nos va a permitir testear las operaciones configuradas en el schema. Para que nos funciones hay que configurar el schema.</p>
<h1 id="configurando-el-schema">
  Configurando el schema
  <a class="anchor" href="#configurando-el-schema">#</a>
</h1>
<p>En la 
  <a href="https://graphql.org/learn/schema/">documentación oficial de GraphQL</a> podemos ver más en detalle las opciones que hay para configurarlo.</p>
<p>El schema que vamos a configurar va ser muy simple ya que se basa en la collection que hice en el 
  <a href="https://irodrigob.github.io/docs/mongodb/cloud/gui_accesocloud/">ejemplo</a> que cree para explicar el GUI de MongoDB.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">import <span style="color:#75715e">{</span> <span style="color:#a6e22e">gql</span> <span style="color:#75715e">}</span> from &#34;apollo-server-micro&#34;;

export const typeDefs = gql`
  type Medidas <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">altura</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Int</span>
    <span style="color:#a6e22e">anchura</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Int</span>
    <span style="color:#a6e22e">unidad</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span>
  <span style="color:#75715e">}</span>
  type Product <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ID</span>
    <span style="color:#a6e22e">mueble</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">!</span>
    <span style="color:#a6e22e">material</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span>
    <span style="color:#a6e22e">medidas</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Medidas</span>
  <span style="color:#75715e">}</span>
  type Query <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">getAll</span><span style="color:#f92672">:</span> <span style="color:#f92672">[</span><span style="color:#a6e22e">Product</span><span style="color:#f92672">]</span>
    <span style="color:#a6e22e">getMuebles</span><span style="color:#f92672">(</span><span style="color:#a6e22e">mueble</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">!):</span> <span style="color:#f92672">[</span><span style="color:#a6e22e">Product</span><span style="color:#f92672">]</span>
    <span style="color:#a6e22e">getSingleMueble</span><span style="color:#f92672">(</span><span style="color:#a6e22e">mueble</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">!):</span> <span style="color:#a6e22e">Product</span>
  <span style="color:#75715e">}</span>

  type Mutation <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">newProduct</span><span style="color:#f92672">(</span><span style="color:#a6e22e">mueble</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">!,</span> <span style="color:#a6e22e">material</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">):</span> <span style="color:#a6e22e">Product</span>
  <span style="color:#75715e">}</span>
`;
</code></pre></div><p>En este schema he creado dos tipos, una query y un mutation. Para ver un ejemplo de su funcionamiento.</p>
<h1 id="conectado-mongodb">
  Conectado MongoDB
  <a class="anchor" href="#conectado-mongodb">#</a>
</h1>
<p>La parte de configuración de la conexión con MongoDB se hace en este 
  <a href="https://irodrigob.github.io/docs/mongodb/usando_app/mongoose/">artículo</a> aparte porque es una configuración que sirve tanto para usarse en aplicación con GraphQL o sin el.</p>
<p>Lo que si que hay que añadir en el fichero <em>graphql.js</em> dentro de la ruta <em>pages-&gt;api</em> es lo siguiente sentencia:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">import &#34;db/config&#34;;
</code></pre></div><p>La gracía de los import que solo se va ejecutar una vez aunque se llame varias veces, por eso se pone en el archivo que inicializa el servidor de Apollo.</p>
<h1 id="probando-en-sandbox">
  Probando en sandbox
  <a class="anchor" href="#probando-en-sandbox">#</a>
</h1>
<p>Con el schema ya configurado y la aplicación de NextJS vamos a entrar en <em>http://localhost:3000/api/graphql</em> y veremos la siguiente pantalla:</p>
<p>
  <img src="/images/graphql/servidor/sandbox_inicio.png" alt="inicio sandbox" /></p>
<p>Si le damos al botón <em>Query your server</em>:</p>
<p>
  <img src="/images/graphql/servidor/sandbox_schemas.png" alt="Schemas del sandbox" /></p>
<p>Por defecto nos sale las querys pero si le damos a <em>Objects</em> podemos los tipos de datos que hemos definido.</p>
<p>Para poder probar las consultas y las mutations hay que implementar el resolver que lo haremos en un artículo aparte.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introducción">Introducción</a></li>
    <li><a href="#instalación">Instalación</a></li>
    <li><a href="#configurando-el-schema">Configurando el schema</a></li>
    <li><a href="#conectado-mongodb">Conectado MongoDB</a></li>
    <li><a href="#probando-en-sandbox">Probando en sandbox</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












