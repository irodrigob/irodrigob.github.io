<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Transfer learning">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Ejemplo transfer learning" />
<meta property="og:description" content="Transfer learning" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://irodrigob.github.io/docs/python/machine_learning/tensorflow/ejemplo_transfer_learning/" />
<meta property="article:modified_time" content="2020-08-08T17:41:20+02:00" />
<title>Ejemplo transfer learning | Navi-developer</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.e40449dffab36960ca7d6bac529d52d7ab9f9d230ffe5de1799e29cb61bc0cb7.css" integrity="sha256-5ARJ3/qzaWDKfWusUp1S16ufnSMP/l3heZ4py2G8DLc=">
<script defer src="/en.search.min.9c399886ccbc58a4aff3c97c343eebf5aa9d06b2ccfc2a580c0961b7cc8738ae.js" integrity="sha256-nDmYhsy8WKSv88l8ND7r9aqdBrLM/CpYDAlht8yHOK4="></script>

<script defer src="/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js" integrity="sha256-dKi7B/C&#43;6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>Navi-developer</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/github/" class="collapsed ">Github</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/graph_ql/" class="collapsed ">GraphQL</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/hugo/" class="">Hugo</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/hugo/publicar_web_github/" class="">Publicar Web Github</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/mongodb/" class="">MongoDB</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/mongodb/usando_app/" class="">MongoDB en aplicaciones</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/mongodb/usando_app/mongoose/" class="">Conector Mongoose</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/mongodb/cloud/" class="collapsed ">MongoDB en cloud</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/" class="collapsed ">Python</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/python/enlaces_interes/" class="">Enlaces de interes</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/entorno_desarrollo/" class="">Entorno de desarrollo</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/extensiones/" class="">Extensiones</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/framework/" class="collapsed ">Frameworks</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/anaconda/" class="">Anaconda</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/configuracion_pylint/" class="">Configuración Pylint</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/" class="collapsed ">Machine learning</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/librerias/" class="">Librerias y paquetes</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/algoritmo_aprendizaje_no_supervisado/" class="collapsed ">Algoritmos de aprendizaje no supervisado</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/arbol_decisiones/" class="collapsed ">Arbol de decisiones</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/estimador_incertidumbre/" class="collapsed ">Estimador incertidumbre</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/guardar_modelos_entrenados/" class="">Guardar modelos entrenados</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/procesamiento_datos/" class="collapsed ">Procesamiento de datos</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/redes_neuronales/" class="collapsed ">Redes neuronales</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/regresion_lineal/" class="collapsed ">Regresion lineal</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/set_datos_propios/" class="collapsed ">Set de datos propios</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/tensorflow/" class="collapsed ">Tensor Flow</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/tensorflow/clasificador_imagenes_ejemplo/" class="">Ejemplo clasificador de imagenes</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/tensorflow/ejemplo_transfer_learning/" class="active">Ejemplo transfer learning</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/tensorflow/reconocimiento_numeros_escrito_mano/" class="">Reconocimiento números escritos a mano</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/tensorflow/usar_datasets/" class="">Usar dataset</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/tensorflow/variables_sesiones/" class="">Variables y sesiones</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/usar_gpu/" class="">Uso GPU</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/machine_learning/vectorizacion/" class="collapsed ">Vectorización</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/sentencias/" class="collapsed ">Sentencias</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/react/" class="collapsed ">React</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/" class="">SAP</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/sap/abap/" class="collapsed ">ABAP</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/BW/" class="collapsed ">BW</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/gateway/" class="collapsed ">Gateway</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/ui5/" class="collapsed ">UI5</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/ventas/" class="collapsed ">Ventas</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  











  
<ul>
  
  <li>
    <a href="https://github.com/irodrigob" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Ejemplo transfer learning</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introducción">Introducción</a></li>
    <li><a href="#código">Código</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="introducción">
  Introducción
  <a class="anchor" href="#introducci%c3%b3n">#</a>
</h1>
<p>Ejemplo extraído del video 
  <a href="https://www.youtube.com/watch?v=09_gmAeHIW0">Importar modelo para clasificar imágenes</a>.</p>
<p>Y el modelo de datos de entrenamiento se puede descargar en el 
  <a href="https://github.com/puigalex/AMP-Tech/blob/master/CNN%20desde%20cero/TransferLearning%28VGG16%29.ipynb">repositorio del ejemplo de Alex Puig</a>.</p>
<p>El transfer learning o transferencia de aprendizaje es una técnica en la cual incorporamos un modelo ya pre-entrenado para utilizarlo para que clasifique lo que nosotros queramos.</p>
<p>Estos modelos son más complejos a nivel de configuración de redes convolucionales como el número de datos usados para entrenarlos. La gracia de usarlos es porque la configurad de la red detecta formas, sombras, cambios de contrastes, etc. Es decir, todo lo necesario para detectar una imagen. Estos modelos para reentranalos haría falta mucha fuerza computacional que uno no tiene en casa.</p>
<p>Keras tiene 
  <a href="https://keras.io/api/applications/">modelos ya preentrenados</a> que se pueden utilizar en nuestras propias clasificaciones. En el ejemplo del video se usará el modelo 
  <a href="https://keras.io/api/applications/vgg/#vgg16-function">VGG16</a> que contiene clasificación de mil imagenes distintas.</p>
<p>En el ejemplo del video se base en el 
  <a href="/docs/python/machine_learning/tensorflow/clasificador_imagenes_ejemplo/">clasificador de imagenes</a> por lo que las explicaciones que hace cada parte del código esta explicado en la página enlazada.</p>
<p>Unas de las cosas que ha mejorado al usar la red VGG16 es que la precisión al clasificar las imagenes ha mejorado muchísimo. Salvo los gorilas que al haber pocas imagenes la tasa de acierto sigo siendo muy baja.</p>
<p>El ejemplo esta creado el <em>Jupiter Notebool</em> y se irá poniendo el código de las distintas celdas. Pero para ver que tal ha mejorado la precisión hay que ejecutar el código de <em>predict.py</em> del clasificador de imagenes.</p>
<p>** NOTA IMPORTANTE: El algoritmo esta entrenado para imagenes 224x224 pixeles. Por lo tanto el codigo utilizado en el clasificador de imagenes hay que cambiarlo para adaptarlo a dicho tamaño**</p>
<h1 id="código">
  Código
  <a class="anchor" href="#c%c3%b3digo">#</a>
</h1>
<p>
  <a href="/docs/python/machine_learning/tensor_flow/tf_ejemplo_transfer_learning.ipynb">Código fuente descargable</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">import sys
import os
import tensorflow as tf
import math
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># VGG16 es un modelo preentrenado que contiene multitud de imagenes.
# Este modelo preentrado es uno de los muchos que tiene Keras
vgg = tf.keras.applications.vgg16.VGG16()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># Resumen de las capas que tiene la red neuronal VGG16
vgg.summary()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># Creación de la red convolucional
cnn = tf.keras.Sequential()

# Se añaden las capas que se ha visto antes a nuestra propia red
for capa in vgg.layers:
    cnn.add(capa)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># Resumen con las capas de nuestra propia red. Debe coincidir con el resumen
# realizado en la red VGG16
cnn.summary()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># Con esto se elimina la capa de predicción. El pop elimina la ultima capa
# del modelo. La ultima capa era la de &#34;predictions&#34; que tiene 1000 parámetros, tipos de imagenes,
# que pued clasificar. Como queremos usarlo para el ejemplo de gatos, gorilas y perros, se quita dicha
# capa para añadir una propia.
cnn.pop()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># Las capas que provienen del VGG16 no queremos entrenarlas porque ya lo han sido
# en el pasado. Por lo tanto, indicamos que no es necesario entrenarlas.
for layer in cnn.layers:
    layer.trainable = False
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># Añadimos una capa de predicción de softmax que tendrá 3 neuronas. Ya que se usará el ejemplo
# de gatos, gorilas y perros.
cnn.add(tf.keras.layers.Dense(3,activation=&#39;softmax&#39;))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># Esta función encapsula lo que hemos hecho en el código anterior paso a paso.
def modelo():
    vgg=tf.keras.applications.vgg16.VGG16()
    cnn=tf.keras.Sequential()
    for capa in vgg.layers:
        cnn.add(capa)
    cnn.pop()
    for layer in cnn.layers:
        layer.trainable = False
    cnn.add(tf.keras.layers.Dense(3,activation=&#39;softmax&#39;))

    return cnn
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># Se limpia todas las variables, estado, etc. de sesión que hemos abierto de keras
tf.keras.backend.clear_session()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl"># Trozo de código del clasificador de imagenes pero aquí no se indicarán las capas convolucionales
data_entrenamiento = &#34;K:/github/python_test/tensorflow/clasificador_imagenes/data/entrenamiento/&#34;
data_validacion = &#34;K:/github/python_test/tensorflow/clasificador_imagenes/data/validacion/&#34;

# Parametros de la red neuronal
# Número de veces que se iteran los datos en el entrenamiento
epocas = 20
# Tamaño de las imagenes. Este es el tamaño que espera la red VGG16, en la documentación
# oficial lo indica.
longitud, altura = 224, 224
# Numero de imagenes que se procesan en cada paso
batch_size = 32
# Al final de cada época se harán 300 pasos con los datos de validación
# para ir viendo como de bien va aprendiendo
validation_steps = 32
# Número de convoluciones o de capas(profundidad) que tendra la iamagen
# Primera convolucion serán 32
filtrosConv1 = 32
# Segunda convolucion serán 64
filtrosConv2 = 64
# Anchura y altura que va a procesar en cada convolucion.
tamano_filtro1 = (3, 3)
tamano_filtro2 = (2, 2)
# Tamaño que se va usar en el maxpooling
tamano_pool = (2, 2)
# Número de clases que hay en el set de datos: gatos, perros y gorilas
clases = 3
# Es el learning rate. Es decir, cuanto de grandes van a ser los ajustes en la red
# para ajustarse para buscar una solución óptima.
lr = 0.0004

# Como se van a transformar las imagenes para poderlas pasar al procesao de entrenamiento
entrenamiento_datagen = tf.keras.preprocessing.image.ImageDataGenerator(
    rescale=1. / 255,
    shear_range=0.2,
    zoom_range=0.2,
    horizontal_flip=True)

# Lo mismo pero para los datos de test
test_datagen = tf.keras.preprocessing.image.ImageDataGenerator(
    rescale=1. / 255)    

# Proceso de lectura y transformación de los datos para los datos de entrenamiento
entrenamiento_generador = entrenamiento_datagen.flow_from_directory(
    data_entrenamiento,
    target_size=(altura, longitud),
    batch_size=batch_size,
    class_mode=&#39;categorical&#39;)

# Lo mismo para los datos de test
validacion_generador = test_datagen.flow_from_directory(
    data_validacion,
    target_size=(altura, longitud),
    batch_size=batch_size,
    class_mode=&#39;categorical&#39;)    
# Se llama a la función que devolverá el modelo adaptado basandonas en la red BGG16
cnn = modelo()

# Se indica como aprenderá el algoritmo
cnn.compile(loss=&#39;categorical_crossentropy&#39;,
            optimizer=tf.keras.optimizers.Adam(lr=lr),
            metrics=[&#39;accuracy&#39;])
# Calculo de pasos por epoca
pasos = math.ceil( ( len(entrenamiento_generador.filenames) / batch_size ) )    

cnn.fit(
    entrenamiento_generador,
    steps_per_epoch=pasos,
    epochs=epocas,
    validation_data=validacion_generador,
    validation_steps=validation_steps )

# Directorio donde se guardará el modelo
target_dir = &#39;K:/github/python_test/tensorflow/clasificador_imagenes/modelo&#39;
if not os.path.exists(target_dir):
 os.mkdir(target_dir)

# Grabación del modelo
cnn.save(&#39;K:/github/python_test/tensorflow/clasificador_imagenes/modelo/modelo.h5&#39;)

# Grabación de los pesos de cada una de las capas
cnn.save_weights(&#39;K:/github/python_test/tensorflow/clasificador_imagenes/modelo/pesos.h5&#39;)   
</code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introducción">Introducción</a></li>
    <li><a href="#código">Código</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












