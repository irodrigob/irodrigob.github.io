<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Conector Mongoose para MongoDB">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Conector Mongoose" />
<meta property="og:description" content="Conector Mongoose para MongoDB" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://irodrigob.github.io/docs/mongodb/usando_app/mongoose/" />
<meta property="article:modified_time" content="2022-01-05T21:13:16+01:00" />
<title>Conector Mongoose | Navi-developer</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.e40449dffab36960ca7d6bac529d52d7ab9f9d230ffe5de1799e29cb61bc0cb7.css" integrity="sha256-5ARJ3/qzaWDKfWusUp1S16ufnSMP/l3heZ4py2G8DLc=">
<script defer src="/en.search.min.ccd9b18d6b91fd57bbf1de4ad5e4cea1e33a29dedbeeeda293ef5d51b4b8ada8.js" integrity="sha256-zNmxjWuR/Ve78d5K1eTOoeM6Kd7b7u2ik&#43;9dUbS4rag="></script>

<script defer src="/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js" integrity="sha256-dKi7B/C&#43;6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>Navi-developer</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/github/" class="collapsed ">Github</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/graph_ql/" class="collapsed ">GraphQL</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/hugo/" class="">Hugo</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/hugo/publicar_web_github/" class="">Publicar Web Github</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/mongodb/" class="">MongoDB</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/mongodb/usando_app/" class="">MongoDB en aplicaciones</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/mongodb/usando_app/mongoose/" class="active">Conector Mongoose</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/mongodb/cloud/" class="collapsed ">MongoDB en cloud</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/python/" class="collapsed ">Python</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/react/" class="collapsed ">React</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/" class="">SAP</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/sap/abap/" class="collapsed ">ABAP</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/BW/" class="collapsed ">BW</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/gateway/" class="collapsed ">Gateway</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/ui5/" class="collapsed ">UI5</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/sap/ventas/" class="collapsed ">Ventas</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  











  
<ul>
  
  <li>
    <a href="https://github.com/irodrigob" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Conector Mongoose</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introducción">Introducción</a></li>
    <li><a href="#instalando-mongoose-en-una-aplicación-nodejs">Instalando Mongoose en una aplicación NodeJS</a></li>
    <li><a href="#creando-el-modelo">Creando el modelo</a></li>
    <li><a href="#usando-la-base-de-datos">Usando la base de datos</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="introducción">
  Introducción
  <a class="anchor" href="#introducci%c3%b3n">#</a>
</h1>
<p>
  <a href="https://mongoosejs.com/">Mongoose</a> es un conector que permite conectar nuestras aplicación con MongoDB.</p>
<h1 id="instalando-mongoose-en-una-aplicación-nodejs">
  Instalando Mongoose en una aplicación NodeJS
  <a class="anchor" href="#instalando-mongoose-en-una-aplicaci%c3%b3n-nodejs">#</a>
</h1>
<p>Este ejemplo es para poder conectar una aplicación hecha en NextJS con la versión MongoDB cloud.</p>
<p>Para poder usar mongoDB en una aplicación hay que instalar mediante:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">npm install mongoose
</code></pre></div><p>Una vez instalado he creado la siguiente estructura de carpetas:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">|- db
|--- config
|----- index.js
|--- models
|----- Product.js
</code></pre></div><p>En la carpeta <em>config</em> es donde tendremos la conexión con la base de datos:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">import mongoose from &#34;mongoose&#34;;

const MONGODB_URI = process.env.MONGODB_URI;

if (!MONGODB_URI) <span style="color:#75715e">{</span>
  <span style="color:#a6e22e">throw</span> <span style="color:#a6e22e">new</span> <span style="color:#a6e22e">Error</span><span style="color:#f92672">(</span>
    <span style="color:#e6db74">&#34;Please define the MONGODB_URI environment variable inside .env.local&#34;</span>
  <span style="color:#f92672">);</span>
<span style="color:#75715e">}</span>

mongoose
  .connect(MONGODB_URI, <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">useNewUrlParser</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
    <span style="color:#a6e22e">useUnifiedTopology</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
  <span style="color:#75715e">}</span>)
  .then(() =&gt; <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">console</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;db success connect&#34;</span><span style="color:#f92672">);</span>
  <span style="color:#75715e">}</span>)
  .catch((error) =&gt; <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">console</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;error connecting to database: &#34;</span><span style="color:#f92672">);</span>
    <span style="color:#a6e22e">console</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">(</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">message</span><span style="color:#f92672">);</span>
  <span style="color:#75715e">}</span>);
</code></pre></div><p>Para el ejemplo voy a conectarme a la versión cloud que tiene MongoDB, en este 
  <a href="https://irodrigob.github.io/docs/mongodb/cloud/">artículo</a> se da más detalle de como hacerlo. En el ráiz del proyecto he creado el fichero <em>.env.local</em> donde tengo la url con el usuario y password de conexión.  Como se construye la URL y como se obtiene esta explicada en este 
  <a href="https://irodrigob.github.io/docs/mongodb/cloud/gui_accesocloud/">artículo</a>.</p>
<p>En este archivo no hago ningún export del código porque lo que haré es importarlo directamente. El motivo es que el import solo se ejecuta una vez aunque lo llamaes varias veces. De esta manera cuando se importe en el código la conexión se llamará solo una vez.</p>
<p>En los ejemplos que he visto hay dos parámetros que se ponen pero en mi caso no ha funcionado, supongo que por versión de la base de datos en el cloud:</p>
<pre><code>useFindAndModify: false,
useCreateIndex: true,
</code></pre><h1 id="creando-el-modelo">
  Creando el modelo
  <a class="anchor" href="#creando-el-modelo">#</a>
</h1>
<p>El siguiente paso es crear los modelos o collections. Los modelos definen que campos y como se van a comportar en los documentos en la colección. En la 
  <a href="https://mongoosejs.com/docs/guide.html#schemas">documentación oficial</a> tenemos más información de como funcionan y sus opciones.</p>
<p>Si en los ejemplos que puse en este 
  <a href="https://irodrigob.github.io/docs/mongodb/cloud/gui_accesocloud/">artículo donde hablo como acceder vía GUI al modelo</a>, ponía cualquier nombre como ejemplo, en este caso y para que funcione hay que tener en cuenta que el nombre del modelo será en singula y la primera letra en mayúsculas. El nombre que le daremos será <em>Product</em> cuando se ejecute el modelo en la base de datos se creará como <em>products</em>. Mongo lo pone a minúsculas y lo pone en plurar.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tpl" data-lang="tpl">import mongoose from &#34;mongoose&#34;;
import uniqueValidator from &#34;mongoose-unique-validator&#34;;

mongoose.Promise = global.Promise;

const ProductSchema = new mongoose.Schema(<span style="color:#75715e">{</span>
  <span style="color:#a6e22e">mueble</span><span style="color:#f92672">:</span> <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">,</span>
    <span style="color:#a6e22e">required</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
    <span style="color:#a6e22e">unique</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
  <span style="color:#75715e">}</span><span style="color:#f92672">,</span>
  <span style="color:#a6e22e">material</span><span style="color:#f92672">:</span> <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">,</span>
  <span style="color:#75715e">}</span><span style="color:#f92672">,</span>
  <span style="color:#a6e22e">medidas</span><span style="color:#f92672">:</span> <span style="color:#75715e">{</span>
    <span style="color:#a6e22e">altura</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Number</span><span style="color:#f92672">,</span>
    <span style="color:#a6e22e">anchura</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Number</span><span style="color:#f92672">,</span>
    <span style="color:#a6e22e">unidad</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">,</span>
  <span style="color:#75715e">}</span><span style="color:#f92672">,</span>
<span style="color:#75715e">}</span>);

ProductSchema.index(<span style="color:#75715e">{</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;mueble&#34;</span> <span style="color:#75715e">}</span>);
ProductSchema.plugin(uniqueValidator);

let Product =
  mongoose.models.Product || mongoose.model(&#34;Product&#34;, ProductSchema);
export default Product;

</code></pre></div><p>En la colección he definido los siguientes campos de dos maneras posibles.</p>
<ul>
<li>name -&gt; Que será será de tipo <em>String</em> y como es un campo importe le he indicado que sea obligatorio y con valor único.</li>
<li>material -&gt; Es un campo string.</li>
<li>medidas -&gt; Es un campo estructurado, es decir, un campo que puede tener otro documento asociado. Esto en una base de datos relacional habría que crear dos tablas y relacionarlas, en MongoDB, al ser no-SQL, podemos poner otro documento en un campo. Podemos ir tantos niveles com queramos.
<ul>
<li>Dentro de medidas tenemos tres campos que los definimos directamente sin necesidad de abrir <em>{}</em> para indicar los atributos del campo.</li>
</ul>
</li>
</ul>
<p>He añadido un plugin que da más detalle, o da mejor detalle según he leído, cuando hay duplicados cuando detecta que un campo tiene el atributo <em>unique: true</em>.</p>
<p>Para evitar el error: <em>OverwriteModelError: Cannot overwrite <code>Product</code> model once compiled</em> pone en la definición de la variable <em>Product</em> que si el modelo ha sido creado previamente devuelva el método y no lo vuelve a crear.</p>
<p>Como hay que usar <em>export default</em> hay que crear un fichero por modelo.</p>
<h1 id="usando-la-base-de-datos">
  Usando la base de datos
  <a class="anchor" href="#usando-la-base-de-datos">#</a>
</h1>
<p>Como voy a usar MongoDB para GraphQL todo eso proceso estará explicando en los artículos GraphQL.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introducción">Introducción</a></li>
    <li><a href="#instalando-mongoose-en-una-aplicación-nodejs">Instalando Mongoose en una aplicación NodeJS</a></li>
    <li><a href="#creando-el-modelo">Creando el modelo</a></li>
    <li><a href="#usando-la-base-de-datos">Usando la base de datos</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












